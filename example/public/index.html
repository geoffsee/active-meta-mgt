<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>active-meta-mgt Evaluation</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
    }

    /* Drawer tab - pier from top */
    .drawer-tab {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      background: #111;
      border: 1px solid #222;
      border-top: none;
      border-left: none;
      border-radius: 0 0 8px 0;
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .drawer-tab:hover { background: #1a1a1a; }
    .drawer-tab h1 {
      font-size: 12px;
      color: #999;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .drawer-tab .arrow {
      color: #666;
      transition: transform 0.3s;
    }
    .drawer-tab.open .arrow { transform: rotate(180deg); }
    .demo-badge { background: #f6c343; color: #000; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700; letter-spacing: 0.05em; }

    /* Drawer panel */
    .drawer-panel {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
      background: #111;
      border-right: 1px solid #222;
      border-bottom: 1px solid #222;
      border-radius: 0 0 8px 0;
      width: 280px;
      max-height: 70vh;
      overflow: hidden;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .drawer-panel.open { transform: translateX(0); }
    .drawer-panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .drawer-panel-header h2 {
      font-size: 13px;
      color: #999;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .drawer-close {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .drawer-close:hover { background: #222; color: #f6c343; }
    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .drawer-resize {
      position: absolute;
      right: 0;
      top: 0;
      width: 5px;
      height: 100%;
      cursor: ew-resize;
      background: transparent;
      transition: background 0.2s;
    }
    .drawer-resize:hover,
    .drawer-resize.dragging {
      background: #f6c343;
    }
    .case-list { list-style: none; }
    .case-list li {
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 2px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .case-list li:hover { background: #1a1a1a; }
    .case-list li.active { background: #1a1a1a; border-left: 3px solid #f6c343; }
    .case-list li.evaluated { opacity: 0.5; }
    .case-list .case-num { color: #666; font-size: 11px; min-width: 28px; }
    .case-list .case-info { flex: 1; font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .case-list .badge { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: #333; font-weight: 600; }
    .case-list .badge.critical { background: #5c2626; color: #fca5a5; }
    .case-list .badge.high { background: #78350f; color: #fcd34d; }

    main { padding: 20px 24px; padding-top: 50px; overflow-y: auto; }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #222;
    }
    .stat { text-align: center; }
    .stat .value { font-size: 24px; font-weight: 700; color: #f6c343; }
    .stat .label { font-size: 11px; color: #666; text-transform: uppercase; }

    .case-detail { display: none; }
    .case-detail.visible { display: block; }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #222;
    }
    .case-header h2 { font-size: 18px; margin-bottom: 6px; }
    .case-header .meta { display: flex; gap: 8px; flex-wrap: wrap; }
    .case-header .meta span { background: #1a1a1a; padding: 4px 10px; border-radius: 4px; font-size: 12px; }
    .case-header .meta .crit { background: #5c2626; color: #fca5a5; }

    .data-quality {
      background: #1a1a0a;
      border: 1px solid #3d3d00;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .data-quality h4 { font-size: 11px; color: #a3a300; margin-bottom: 8px; text-transform: uppercase; }
    .data-quality .bar { height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
    .data-quality .bar-fill { height: 100%; background: linear-gradient(90deg, #dc2626, #f59e0b, #22c55e); }
    .data-quality .gaps { font-size: 11px; color: #888; }
    .data-quality .gap-item { display: inline-block; background: #2a1a1a; color: #f87171; padding: 2px 6px; border-radius: 3px; margin: 2px; font-size: 10px; }

    .clinical-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    @media (max-width: 1200px) { .clinical-grid { grid-template-columns: repeat(2, 1fr); } }

    .clinical-section {
      background: #111;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 12px;
    }
    .clinical-section h3 {
      margin: 0 0 8px;
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      justify-content: space-between;
    }
    .clinical-section h3 .count { color: #444; }

    .clinical-data { font-size: 12px; line-height: 1.5; }
    .clinical-data .row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .clinical-data .row:last-child { border-bottom: none; }
    .clinical-data .row.missing { opacity: 0.4; }
    .clinical-data .label { color: #666; }
    .clinical-data .value { text-align: right; }
    .clinical-data .value.critical { color: #fca5a5; font-weight: 600; }
    .clinical-data .value.warning { color: #fcd34d; }
    .clinical-data .value.normal { color: #86efac; }
    .clinical-data .value.missing { color: #444; font-style: italic; }
    .clinical-data .ref { color: #444; font-size: 10px; margin-left: 4px; }

    .clinical-data .pill {
      display: inline-block;
      background: #1a1a1a;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 2px;
      font-size: 11px;
    }
    .clinical-data .pill.alert { background: #5c2626; color: #fca5a5; }
    .clinical-data .none { color: #444; font-style: italic; font-size: 11px; }

    .eval-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #222;
    }
    .eval-section > h3 {
      font-size: 12px;
      color: #888;
      margin: 0 0 12px;
      text-transform: uppercase;
    }

    /* Specialist Cards */
    .specialist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .specialist-card {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      overflow: hidden;
    }
    .specialist-card.loading { opacity: 0.7; }
    .specialist-card.error { border-color: #5c2626; }

    .specialist-header {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #222;
    }
    .specialist-header .icon { font-size: 20px; }
    .specialist-header .title {
      flex: 1;
      font-weight: 600;
      font-size: 13px;
    }
    .specialist-header .status {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
    }
    .specialist-header .status.pending { background: #333; color: #888; }
    .specialist-header .status.loading { background: #1e3a5f; color: #60a5fa; }
    .specialist-header .status.success { background: #14532d; color: #86efac; }
    .specialist-header .status.error { background: #5c2626; color: #fca5a5; }

    .specialist-body {
      padding: 12px 14px;
      font-size: 12px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
    }
    .specialist-body.empty { color: #444; font-style: italic; }

    .specialist-body h1, .specialist-body h2, .specialist-body h3, .specialist-body h4 {
      font-size: 12px;
      font-weight: 600;
      margin: 12px 0 6px;
      color: #ccc;
    }
    .specialist-body h1:first-child, .specialist-body h2:first-child,
    .specialist-body h3:first-child, .specialist-body h4:first-child {
      margin-top: 0;
    }
    .specialist-body ul, .specialist-body ol {
      margin: 6px 0;
      padding-left: 20px;
    }
    .specialist-body li { margin: 4px 0; }
    .specialist-body strong { color: #f6c343; }
    .specialist-body code {
      background: #1a1a1a;
      padding: 1px 4px;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
    }

    .specialist-context {
      padding: 8px 14px;
      background: #0a0a0a;
      border-top: 1px solid #1a1a1a;
      font-size: 10px;
      color: #555;
    }
    .specialist-context summary {
      cursor: pointer;
      user-select: none;
    }
    .specialist-context pre {
      margin-top: 8px;
      white-space: pre-wrap;
      font-family: 'SF Mono', Monaco, monospace;
      max-height: 150px;
      overflow-y: auto;
      color: #666;
    }

    /* Structured outputs */
    .structured { margin-top: 18px; }
    .structured-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 1200px) { .structured-row { grid-template-columns: 1fr; } }
    .panel {
      background: #0d0d0d;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 12px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #777;
      margin-bottom: 8px;
    }
    .panel-body {
      font-size: 12px;
      line-height: 1.5;
      display: grid;
      gap: 8px;
    }
    .finding {
      border: 1px solid #1f1f1f;
      border-left: 3px solid #333;
      padding: 8px 10px;
      border-radius: 6px;
      background: #111;
    }
    .finding .title { font-weight: 600; margin-bottom: 4px; }
    .finding .meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 11px;
      color: #777;
      margin-bottom: 4px;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #1a1a1a;
      font-size: 11px;
      color: #aaa;
    }
    .tag.sev-critical { background: #5c2626; color: #fca5a5; }
    .tag.sev-high { background: #7a4414; color: #fcd34d; }
    .tag.sev-moderate { background: #1f2a1f; color: #86efac; }
    .tag.sev-info { background: #1a1a1a; color: #9ca3af; }
    .tag.conf-low { background: #1e293b; color: #93c5fd; }
    .tag.conf-medium { background: #1f2937; color: #cbd5e1; }
    .tag.conf-high { background: #0f172a; color: #a5b4fc; }
    .empty-note { color: #555; font-style: italic; }
    .conflict {
      border: 1px solid #2a1a1a;
      background: #120808;
      border-radius: 6px;
      padding: 8px 10px;
    }
    .followup {
      border: 1px solid #1c2430;
      background: #0c121b;
      border-radius: 6px;
      padding: 8px 10px;
    }
    .pill-id { font-family: 'SF Mono', monospace; font-size: 10px; color: #555; }

    button {
      background: #f6c343;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: #f7d06b; }
    button:disabled { background: #333; color: #666; cursor: not-allowed; }
    button.secondary { background: #222; color: #999; }
    button.secondary:hover { background: #333; }

    .actions { display: flex; gap: 10px; margin-top: 16px; }

    .empty { color: #666; text-align: center; padding: 60px; }

    .data-info {
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 8px;
      margin-bottom: 20px;
      margin-left: 24px;
      font-size: 13px;
    }
    .data-info summary {
      padding: 12px 16px;
      cursor: pointer;
      color: #8b949e;
      font-weight: 500;
    }
    .data-info summary:hover { color: #c9d1d9; }
    .data-info[open] summary { border-bottom: 1px solid #21262d; }
    .data-info-content {
      padding: 16px;
      color: #8b949e;
      line-height: 1.5;
    }
    .data-info-content p { margin-bottom: 12px; }
    .source-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 12px;
    }
    .source-table th, .source-table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #21262d;
    }
    .source-table th {
      background: #161b22;
      color: #c9d1d9;
      font-weight: 600;
    }
    .source-table td { color: #8b949e; }
    .source-table a { color: #f6c343; text-decoration: none; }
    .source-table a:hover { text-decoration: underline; }
    .data-note {
      font-size: 12px;
      color: #f6c343;
      font-style: normal;
      font-weight: 500;
      margin-top: 16px;
      margin-bottom: 0;
      padding: 12px 14px;
      background: rgba(246, 195, 67, 0.1);
      border: 1px solid rgba(246, 195, 67, 0.3);
      border-radius: 6px;
      text-align: center;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-pulse { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>
    <!-- Drawer tab (pier) -->
  <div class="drawer-tab" id="drawer-tab">
    <h1>Cases (<span id="case-count">0</span>) <span class="demo-badge">Demo</span></h1>
    <span class="arrow">&#9662;</span>
  </div>

  <!-- Drawer panel -->
  <div class="drawer-panel" id="drawer-panel">
    <div class="drawer-panel-header">
      <h2>Select Case</h2>
      <button class="drawer-close" id="drawer-close">&times;</button>
    </div>
    <div class="drawer-content">
      <ul class="case-list" id="case-list"></ul>
    </div>
    <div class="drawer-resize" id="drawer-resize"></div>
  </div>

  <main>
    <details class="data-info" open>
      <summary>Data Info</summary>
      <div class="data-info-content">
        <p>
          Patient records are created by combining multiple healthcare datasets.
          Records are matched by demographics (age group, gender) and condition type,
          then merged to create realistic clinical scenarios with complete vitals and lab values.
        </p>
        <table class="source-table">
          <thead>
            <tr><th>Source</th><th>Data Provided</th><th>License</th></tr>
          </thead>
          <tbody>
            <tr>
              <td><a href="https://physionet.org/content/mimiciii/" target="_blank">MIMIC-III</a></td>
              <td>Patient demographics, diagnoses (ICD-9), medications, chemistry labs</td>
              <td>PhysioNet Credentialed</td>
            </tr>
            <tr>
              <td><a href="https://www.kaggle.com/datasets" target="_blank">Oxygen Dataset</a></td>
              <td>Vital signs (SpO2, heart rate, oxygen flow), critical status</td>
              <td>CC0 Public Domain</td>
            </tr>
            <tr>
              <td><a href="https://www.kaggle.com/datasets" target="_blank">Healthcare Dataset</a></td>
              <td>Demographics, insurance, blood type</td>
              <td>CC0 Public Domain</td>
            </tr>
            <tr>
              <td><a href="https://www.kaggle.com/datasets" target="_blank">CBC Dataset</a></td>
              <td>Complete blood count (WBC, RBC, hemoglobin, platelets, differentials)</td>
              <td>CC0 Public Domain</td>
            </tr>
          </tbody>
        </table>
        <p class="data-note">
          Records are synthetic composites for demonstration purposes. No real patient data is displayed.
        </p>
      </div>
    </details>
    <div class="stats" id="stats"></div>
    <div class="empty" id="empty-state">Select a case to evaluate</div>

    <div class="case-detail" id="case-detail">
      <div class="case-header">
        <div>
          <h2 id="case-title"></h2>
          <div class="meta" id="case-meta"></div>
        </div>
        <div id="severity-badge"></div>
      </div>

      <div class="data-quality" id="data-quality"></div>

      <div class="clinical-grid">
        <div class="clinical-section">
          <h3>Demographics</h3>
          <div id="demographics-info" class="clinical-data"></div>
        </div>
        <div class="clinical-section">
          <h3>Vitals <span class="count" id="vitals-count"></span></h3>
          <div id="vitals-info" class="clinical-data"></div>
        </div>
        <div class="clinical-section">
          <h3>Labs <span class="count" id="labs-count"></span></h3>
          <div id="labs-info" class="clinical-data"></div>
        </div>
        <div class="clinical-section">
          <h3>Medications <span class="count" id="meds-count"></span></h3>
          <div id="meds-info" class="clinical-data"></div>
        </div>
        <div class="clinical-section">
          <h3>Diagnoses</h3>
          <div id="dx-info" class="clinical-data"></div>
        </div>
        <div class="clinical-section">
          <h3>Allergies</h3>
          <div id="allergies-info" class="clinical-data"></div>
        </div>
      </div>

      <div class="eval-section">
        <h3>Clinical Decision Support <span style="font-size:10px;color:#666;text-transform:none;font-weight:normal;">— powered by active-meta-mgt multi-lane architecture</span></h3>

        <div class="specialist-grid" id="specialist-grid"></div>

        <div class="structured" id="structured" style="display:none;">
          <div class="structured-row">
            <div class="panel">
              <div class="panel-header">Structured Findings <span class="pill-id" id="findings-count"></span></div>
              <div class="panel-body" id="findings-body"></div>
            </div>
            <div class="panel">
              <div class="panel-header">Conflicts <span class="pill-id" id="conflicts-count"></span></div>
              <div class="panel-body" id="conflicts-body"></div>
            </div>
            <div class="panel">
              <div class="panel-header">Follow-ups <span class="pill-id" id="followups-count"></span></div>
              <div class="panel-body" id="followups-body"></div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="evaluate-btn">Evaluate Case</button>
          <button id="refresh-btn" class="secondary" style="display:none;">Refresh (bypass cache)</button>
          <span id="cache-indicator" style="display:none;font-size:11px;color:#86efac;margin-left:8px;"></span>
          <button id="export-btn" class="secondary">Export All (JSON)</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API = '';
    let patients = [];
    let evaluations = [];
    let selectedPatient = null;
    let fullPatientData = null;
    let specialists = [];

    // DOM refs
    const $ = id => document.getElementById(id);
    const caseList = $('case-list');
    const caseCount = $('case-count');
    const statsEl = $('stats');
    const emptyState = $('empty-state');
    const caseDetail = $('case-detail');
    const specialistGrid = $('specialist-grid');
    const structuredRoot = $('structured');
    const findingsBody = $('findings-body');
    const conflictsBody = $('conflicts-body');
    const followupsBody = $('followups-body');
    const findingsCount = $('findings-count');
    const conflictsCount = $('conflicts-count');
    const followupsCount = $('followups-count');

    // Drawer toggle
    const drawerTab = $('drawer-tab');
    const drawerPanel = $('drawer-panel');
    const drawerClose = $('drawer-close');

    function toggleDrawer(open) {
      const isOpen = open !== undefined ? open : !drawerPanel.classList.contains('open');
      drawerPanel.classList.toggle('open', isOpen);
      drawerTab.classList.toggle('open', isOpen);
    }

    drawerTab.addEventListener('click', () => toggleDrawer());
    drawerClose.addEventListener('click', () => toggleDrawer(false));

    // Close drawer when clicking outside
    document.addEventListener('click', (e) => {
      if (!drawerPanel.contains(e.target) && !drawerTab.contains(e.target)) {
        toggleDrawer(false);
      }
    });

    // Drawer resize
    const drawerResize = $('drawer-resize');
    let isResizing = false;

    drawerResize.addEventListener('mousedown', (e) => {
      isResizing = true;
      drawerResize.classList.add('dragging');
      document.body.style.cursor = 'ew-resize';
      document.body.style.userSelect = 'none';
      e.stopPropagation();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const newWidth = e.clientX;
      if (newWidth >= 200 && newWidth <= 500) {
        drawerPanel.style.width = newWidth + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        drawerResize.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }
    });

    // Simple markdown parser
    function renderMarkdown(text) {
      if (!text) return '';
      return text
        // Headers
        .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        // Bold
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Lists (simple)
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
        // Wrap consecutive <li> in <ul>
        .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
        // Line breaks
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
    }

    const esc = (s = '') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] || c));

    function severityClass(sev) {
      if (sev === 'critical') return 'critical';
      if (sev === 'high') return 'high';
      if (sev === 'moderate') return 'moderate';
      return 'info';
    }

    function renderStructured(structured) {
      if (!structured) {
        structuredRoot.style.display = 'none';
        findingsBody.innerHTML = '';
        conflictsBody.innerHTML = '';
        followupsBody.innerHTML = '';
        return;
      }
      structuredRoot.style.display = 'block';

      const findings = structured.findings || [];
      findingsCount.textContent = findings.length ? `${findings.length}` : '';
      findingsBody.innerHTML = findings.length
        ? findings.map(f => `
            <div class="finding">
              <div class="title">${esc(f.title)}</div>
              <div class="meta">
                <span class="tag sev-${severityClass(f.severity)}">${f.severity}</span>
                <span class="tag conf-${f.confidence}">conf ${f.confidence}</span>
                <span class="tag">${esc(f.category)}</span>
                <span class="tag">${esc(f.specialistId || '')}</span>
                ${f.timeframe ? `<span class="tag">${esc(f.timeframe)}</span>` : ''}
              </div>
              ${f.rationale ? `<div>${esc(f.rationale)}</div>` : ''}
              ${f.tags?.length ? `<div class="meta">${f.tags.map(t => `<span class="tag">${esc(t.key)}${t.value ? ':'+esc(t.value) : ''}</span>`).join('')}</div>` : ''}
              <div class="pill-id">${esc(f.id)}</div>
            </div>
          `).join('')
        : '<div class="empty-note">No structured findings</div>';

      const conflicts = structured.conflicts || [];
      conflictsCount.textContent = conflicts.length ? `${conflicts.length}` : '';
      conflictsBody.innerHTML = conflicts.length
        ? conflicts.map(c => `
            <div class="conflict">
              <div class="title">${esc(c.summary || 'Conflict')}</div>
              <div class="meta">
                <span class="tag sev-${severityClass(c.severity)}">${c.severity}</span>
                ${c.involvedFindingIds?.length ? `<span class="tag">${c.involvedFindingIds.length} finding(s)</span>` : ''}
              </div>
              ${c.involvedFindingIds?.length ? `<div class="pill-id">${c.involvedFindingIds.map(esc).join(', ')}</div>` : ''}
              <div class="pill-id">${esc(c.id)}</div>
            </div>
          `).join('')
        : '<div class="empty-note">No conflicts detected</div>';

      const followups = structured.followUps || [];
      followupsCount.textContent = followups.length ? `${followups.length}` : '';
      followupsBody.innerHTML = followups.length
        ? followups.map(f => `
            <div class="followup">
              <div class="title">${esc(f.action)}</div>
              <div class="meta">
                <span class="tag sev-${severityClass(f.severity)}">${f.severity}</span>
              </div>
              <div>${esc(f.reason)}</div>
              <div class="pill-id">${esc(f.id)}</div>
            </div>
          `).join('')
        : '<div class="empty-note">No follow-ups</div>';
    }

    async function init() {
      // Load specialists config
      const specRes = await fetch(`${API}/api/specialists`);
      const specData = await specRes.json();
      specialists = specData.specialists;

      // Load patients
      const res = await fetch(`${API}/api/patients?limit=100`);
      const data = await res.json();
      patients = data.patients;
      caseCount.textContent = patients.length;
      renderStats(data.stats);
      renderCaseList();
      renderEmptySpecialistCards();
    }

    function renderStats(stats) {
      statsEl.innerHTML = `
        <div class="stat"><div class="value">${stats.total}</div><div class="label">Cases</div></div>
        <div class="stat"><div class="value">${stats.critical}</div><div class="label">Critical</div></div>
        <div class="stat"><div class="value">${evaluations.length}</div><div class="label">Evaluated</div></div>
      `;
    }

    function renderCaseList() {
      caseList.innerHTML = patients.map((p, i) => {
        const evaluated = evaluations.some(e => e.patientId === p.id);
        const sevClass = p.criticalFlag ? 'critical' : p.severityScore >= 6 ? 'high' : '';
        const sevLabel = p.criticalFlag ? 'CRIT' : `S${p.severityScore}`;
        return `
          <li data-id="${p.id}" class="${evaluated ? 'evaluated' : ''} ${selectedPatient?.id === p.id ? 'active' : ''}">
            <span class="case-num">#${i + 1}</span>
            <span class="case-info">${p.primaryDiagnosis}</span>
            <span class="badge ${sevClass}">${sevLabel}</span>
          </li>
        `;
      }).join('');

      caseList.querySelectorAll('li').forEach(li => {
        li.addEventListener('click', () => selectCase(li.dataset.id));
      });
    }

    function renderEmptySpecialistCards() {
      specialistGrid.innerHTML = specialists.map(s => `
        <div class="specialist-card" data-id="${s.id}">
          <div class="specialist-header" style="border-left: 3px solid ${s.color};">
            <span class="icon">${s.icon}</span>
            <span class="title">${s.name}</span>
            <span class="status pending">Pending</span>
          </div>
          <div class="specialist-body empty">${s.description}</div>
        </div>
      `).join('');
    }

    function updateSpecialistCard(id, { status, response, error, workingMemory }) {
      const card = specialistGrid.querySelector(`[data-id="${id}"]`);
      if (!card) return;

      const statusEl = card.querySelector('.status');
      const bodyEl = card.querySelector('.specialist-body');

      // Update status
      statusEl.className = `status ${status}`;
      statusEl.textContent = status === 'loading' ? 'Loading...' :
                             status === 'success' ? 'Complete' :
                             status === 'error' ? 'Error' : 'Pending';

      // Update body
      if (status === 'loading') {
        card.classList.add('loading');
        bodyEl.innerHTML = '<span class="loading-pulse">Analyzing...</span>';
        bodyEl.classList.remove('empty');
      } else if (status === 'success') {
        card.classList.remove('loading');
        bodyEl.innerHTML = renderMarkdown(response);
        bodyEl.classList.remove('empty');

        // Add context details
        if (workingMemory) {
          const existing = card.querySelector('.specialist-context');
          if (existing) existing.remove();

          const contextEl = document.createElement('details');
          contextEl.className = 'specialist-context';
          contextEl.innerHTML = `
            <summary>View working memory context</summary>
            <pre>${workingMemory}</pre>
          `;
          card.appendChild(contextEl);
        }
      } else if (status === 'error') {
        card.classList.remove('loading');
        card.classList.add('error');
        bodyEl.innerHTML = `<span style="color:#fca5a5;">Error: ${error}</span>`;
        bodyEl.classList.remove('empty');
      }
    }

    async function selectCase(id) {
      selectedPatient = patients.find(p => p.id === id);
      if (!selectedPatient) return;

      // Close the drawer
      toggleDrawer(false);

      emptyState.style.display = 'none';
      caseDetail.classList.add('visible');

      // Fetch full patient data
      const res = await fetch(`${API}/api/patients/${id}`);
      fullPatientData = await res.json();
      renderPatientDetails(fullPatientData);

      // Reset specialist cards
      renderEmptySpecialistCards();
      $('evaluate-btn').disabled = false;
      $('evaluate-btn').textContent = 'Evaluate Case';
      $('refresh-btn').style.display = 'none';
      $('cache-indicator').style.display = 'none';
      renderStructured(null);

      renderCaseList();
    }

    function renderPatientDetails(p) {
      // Header
      $('case-title').textContent = p.primary_diagnosis;
      $('case-meta').innerHTML = `
        <span>${p.patient_id}</span>
        <span>${p.gender}, ${p.age}y</span>
        <span>${p.condition_category}</span>
        <span>${p.admission_type}</span>
      `;
      $('severity-badge').innerHTML = p.critical_flag
        ? '<span style="background:#5c2626;color:#fca5a5;padding:8px 16px;border-radius:6px;font-weight:700;">CRITICAL</span>'
        : `<span style="background:#333;padding:8px 16px;border-radius:6px;">Severity ${p.severity_score}/10</span>`;

      // Data quality assessment
      const gaps = [];
      const v = p.vitals || {};
      const l = p.labs || {};

      // Check critical fields based on condition
      if (v.systolic_bp == null) gaps.push('BP');
      if (v.temperature == null) gaps.push('Temp');
      if (v.respiratory_rate == null) gaps.push('RR');
      if (l.lactate == null) gaps.push('Lactate');
      if (l.creatinine == null) gaps.push('Creatinine');
      if (l.potassium == null) gaps.push('Potassium');
      if (l.platelets == null) gaps.push('Platelets');
      if (l.wbc == null) gaps.push('WBC');
      if (!p.weight) gaps.push('Weight');
      if (!p.code_status) gaps.push('Code Status');

      const totalFields = 10;
      const available = totalFields - gaps.length;
      const pct = Math.round((available / totalFields) * 100);

      $('data-quality').innerHTML = `
        <h4>Data Completeness: ${pct}%</h4>
        <div class="bar"><div class="bar-fill" style="width:${pct}%"></div></div>
        <div class="gaps">
          <strong>Missing critical fields:</strong>
          ${gaps.length ? gaps.map(g => `<span class="gap-item">${g}</span>`).join('') : '<span style="color:#86efac;">None</span>'}
        </div>
      `;

      // Demographics
      $('demographics-info').innerHTML = `
        <div class="row"><span class="label">Age</span><span class="value">${p.age} (${p.age_bucket})</span></div>
        <div class="row"><span class="label">Gender</span><span class="value">${p.gender}</span></div>
        <div class="row"><span class="label">Blood Type</span><span class="value">${p.blood_type || '—'}</span></div>
        <div class="row"><span class="label">Insurance</span><span class="value">${p.insurance || '—'}</span></div>
        <div class="row ${!p.weight ? 'missing' : ''}"><span class="label">Weight</span><span class="value missing">Not recorded</span></div>
        <div class="row ${!p.code_status ? 'missing' : ''}"><span class="label">Code Status</span><span class="value missing">Not recorded</span></div>
      `;

      // Vitals with clinical thresholds
      const vitalsData = [
        ['SpO2', v.spo2, '%', 95, 100, v.spo2 < 90 ? 'critical' : v.spo2 < 94 ? 'warning' : 'normal'],
        ['Heart Rate', v.heart_rate, 'bpm', 60, 100, v.heart_rate > 100 ? 'warning' : v.heart_rate > 120 ? 'critical' : 'normal'],
        ['BP', v.systolic_bp && v.diastolic_bp ? `${Math.round(v.systolic_bp)}/${Math.round(v.diastolic_bp)}` : null, 'mmHg', null, null, v.systolic_bp < 90 ? 'critical' : v.systolic_bp < 100 ? 'warning' : 'normal'],
        ['Temp', v.temperature != null ? Math.round(v.temperature * 10) / 10 : null, '°F', 97.8, 99.5, v.temperature > 100.4 ? 'critical' : v.temperature > 99.5 || v.temperature < 96 ? 'warning' : 'normal'],
        ['Resp Rate', v.respiratory_rate, '/min', 12, 20, v.respiratory_rate > 22 ? 'critical' : v.respiratory_rate > 20 ? 'warning' : 'normal'],
        ['O2 Flow', v.oxygen_flow, 'L/min', null, null, v.oxygen_flow > 10 ? 'critical' : v.oxygen_flow > 4 ? 'warning' : 'normal'],
        ['Resp Status', v.respiratory_status, '', null, null, v.respiratory_status === 'critical' ? 'critical' : null],
      ];
      const vitalsAvailable = vitalsData.filter(([_, val]) => val != null).length;
      $('vitals-count').textContent = `${vitalsAvailable}/${vitalsData.length}`;
      $('vitals-info').innerHTML = vitalsData.map(([name, val, unit, low, high, cls]) => {
        if (val == null) return `<div class="row missing"><span class="label">${name}</span><span class="value missing">—</span></div>`;
        return `<div class="row"><span class="label">${name}</span><span class="value ${cls || ''}">${val}${unit ? ' ' + unit : ''}</span></div>`;
      }).join('');

      // Labs with reference ranges - critical labs first
      const labsData = [
        ['Lactate', l.lactate, 'mmol/L', 0.5, 2],
        ['Creatinine', l.creatinine, 'mg/dL', 0.7, 1.3],
        ['Potassium', l.potassium, 'mEq/L', 3.5, 5.0],
        ['Glucose', l.glucose, 'mg/dL', 70, 180],
        ['Platelets', l.platelets, 'K/uL', 150, 400],
        ['WBC', l.wbc, 'K/uL', 4.5, 11],
        ['Hgb', l.hemoglobin, 'g/dL', 12, 17.5],
        ['Hct', l.hematocrit, '%', 36, 50],
        ['Sodium', l.sodium, 'mEq/L', 136, 145],
        ['BUN', l.bun, 'mg/dL', 7, 20],
        ['RBC', l.rbc, 'M/uL', 4.0, 5.5],
        ['Neutrophils', l.neutrophils, '%', 40, 70],
      ];
      const labsAvailable = labsData.filter(([_, val]) => val != null).length;
      $('labs-count').textContent = `${labsAvailable}/${labsData.length}`;
      $('labs-info').innerHTML = labsData.map(([name, val, unit, low, high]) => {
        if (val == null) return `<div class="row missing"><span class="label">${name}</span><span class="value missing">—<span class="ref">(${low}-${high})</span></span></div>`;
        const numVal = parseFloat(val);
        const cls = numVal < low ? 'warning' : numVal > high ? 'critical' : 'normal';
        return `<div class="row"><span class="label">${name}</span><span class="value ${cls}">${numVal.toFixed(1)} ${unit}<span class="ref">(${low}-${high})</span></span></div>`;
      }).join('');

      // Medications
      const meds = p.medications || [];
      $('meds-count').textContent = meds.length;
      $('meds-info').innerHTML = meds.length
        ? meds.map(m => `<span class="pill">${m}</span>`).join('')
        : '<span class="none">None documented</span>';

      // Diagnoses
      $('dx-info').innerHTML = `
        <div class="row"><span class="label">Primary</span><span class="value">${p.primary_diagnosis}</span></div>
        <div class="row"><span class="label">ICD-9</span><span class="value">${p.icd9_code}</span></div>
        ${p.secondary_diagnoses?.length ? `
          <div style="margin-top:8px;font-size:11px;color:#666;">Secondary (${p.secondary_diagnoses.length}):</div>
          ${p.secondary_diagnoses.map(d => `<span class="pill">${d}</span>`).join('')}
        ` : ''}
      `;

      // Allergies
      const allergies = p.allergies || [];
      $('allergies-info').innerHTML = allergies.length
        ? allergies.map(a => `<span class="pill alert">${a}</span>`).join('')
        : '<span class="none">NKDA (No Known Drug Allergies)</span>';
    }

    async function runEvaluation(forceRefresh = false) {
      if (!selectedPatient) return;

      const btn = $('evaluate-btn');
      const refreshBtn = $('refresh-btn');
      const cacheIndicator = $('cache-indicator');

      btn.disabled = true;
      refreshBtn.style.display = 'none';
      cacheIndicator.style.display = 'none';
      btn.textContent = 'Evaluating...';

      // Set all cards to loading state
      specialists.forEach(s => {
        updateSpecialistCard(s.id, { status: 'loading' });
      });

      try {
        const url = forceRefresh
          ? `${API}/api/scenarios/generate/${selectedPatient.id}/evaluate?refresh=true`
          : `${API}/api/scenarios/generate/${selectedPatient.id}/evaluate`;

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await res.json();

        if (res.status === 429) {
          // Rate limited - show cooldown message
          const mins = Math.ceil((data.retryAfter || 0) / 60);
          const hrs = Math.floor(mins / 60);
          const remainMins = mins % 60;
          const timeStr = hrs > 0 ? `${hrs}h ${remainMins}m` : `${mins}m`;
          specialists.forEach(s => {
            updateSpecialistCard(s.id, {
              status: 'error',
              error: `Rate limited: wait ${timeStr} before re-evaluating this patient`
            });
          });
          renderStructured(null);
          btn.textContent = `Cooldown (${timeStr})`;
          btn.disabled = true;
          // Re-enable button after cooldown
          setTimeout(() => {
            btn.textContent = 'Evaluate Case';
            btn.disabled = false;
          }, (data.retryAfter || 60) * 1000);
        } else if (data.error) {
          specialists.forEach(s => {
            updateSpecialistCard(s.id, { status: 'error', error: data.error });
          });
          renderStructured(null);
        } else {
          // Update each specialist card with its result
          data.specialists.forEach(result => {
            updateSpecialistCard(result.id, {
              status: result.status,
              response: result.response,
              error: result.error,
              workingMemory: result.workingMemory,
            });
          });

          renderStructured(data.structured);

          // Show cache indicator
          if (data.cached) {
            cacheIndicator.textContent = `Cached result from ${new Date(data.timestamp).toLocaleString()}`;
            cacheIndicator.style.display = 'inline';
            refreshBtn.style.display = 'inline-block';
          } else {
            cacheIndicator.textContent = 'Fresh evaluation';
            cacheIndicator.style.display = 'inline';
            refreshBtn.style.display = 'none';
          }

          // Save evaluation
          evaluations.push({
            timestamp: new Date().toISOString(),
            patientId: selectedPatient.id,
            diagnosis: selectedPatient.primaryDiagnosis,
            category: selectedPatient.category,
            severity: selectedPatient.severityScore,
            critical: selectedPatient.criticalFlag,
            patient: fullPatientData,
            specialists: data.specialists,
            scenario: data.scenario,
            structured: data.structured,
            cached: data.cached,
          });

          renderCaseList();
          renderStats({ total: patients.length, critical: patients.filter(p => p.criticalFlag).length });
        }
      } catch (err) {
        specialists.forEach(s => {
          updateSpecialistCard(s.id, { status: 'error', error: err.message });
        });
        renderStructured(null);
      }

      btn.textContent = 'Evaluate Again';
      btn.disabled = false;
    }

    $('evaluate-btn').addEventListener('click', () => runEvaluation(false));
    $('refresh-btn').addEventListener('click', () => runEvaluation(true));

    $('export-btn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(evaluations, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `active-meta-mgt-eval-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    init();
  </script>
</body>
</html>
